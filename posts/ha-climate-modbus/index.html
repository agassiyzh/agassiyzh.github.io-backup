<!doctype html><html lang=zn-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="小於"><title>ModBus 空调组件及中央空调接入 Home Assistant 细节 ｜ 小於的宅基地</title><meta name=description content="--     玩Home Assistant有一段日子了。一直想把家里的中央空调接入进去。无意间Google到Yonsm老师的blog好像看到了一线希望：《ModBus 空调组件及中央空调接入 Home Assistant 简述》。
于是按照文章和论坛中讨论的指引购入了相关的模块。由于第一次玩modbus这个工业互联协议，中间也走了不少弯路。这里对《ModBus 空调组件及中央空调接入 Home Assistant 简述》没有提及的细节做一个补充.
开始之前首先要在心理上做好打持久战的准备😱️"><meta name=keywords content="技术,园艺,Iot,生活,感悟,育儿"><link rel="shortcut icon" href=http://localhost:1313/images/favicon.ico><link rel=stylesheet type=text/css media=screen href=http://localhost:1313/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css><link rel=stylesheet type=text/css media=screen href=http://localhost:1313/css/zozo.css><link rel=stylesheet type=text/css media=screen href=http://localhost:1313/css/customize.css><link rel=stylesheet type=text/css media=screen href=https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css><link rel=stylesheet type=text/css media=screen href=http://localhost:1313/css/highlight.css></head><body><div class="main animate__animated animate__fadeInDown"><div class="nav_container animated fadeInDown"><div class=site_nav id=site_nav><ul><li><a href=/>Home</a></li><li><a href=/posts/>Archive</a></li><li><a href=/tags/>Tags</a></li><li><a href=/about/>About</a></li></ul></div><div class=menu_icon><a id=menu_icon><i class=ri-menu-line></i></a></div></div><div class="header animated fadeInDown"><div class=site_title_container><div class=site_title><h1><a href=http://localhost:1313/><span>小於的宅基地</span></a></h1></div><div class=description><p class=sub_title>但愿每次回忆都不觉愧疚</p><div class=my_socials><a href=https://github.com/agassiyzh title=github target=_blank><i class=ri-github-fill></i></a><a href=https://twitter.com/agassi_yzh title=twitter target=_blank><i class=ri-twitter-fill></i></a><a href=http://localhost:1313/index.xml type=application/rss+xml title=rss target=_blank><i class=ri-rss-fill></i></a></div></div></div></div><div class=content><div class=post_page><div class="post animate__animated animate__fadeInDown"><div class="post_title post_detail_title"><h2><a href=/posts/ha-climate-modbus/>ModBus 空调组件及中央空调接入 Home Assistant 细节</a></h2><span class=date>2018.10.29</span></div><div class="post_content markdown"><div style=width:100%;display:flex;display:-webkit-flex><div style=width:66%><video style=width:95% src=/images/HA-climate-modbus/siri.mp4 controls></video></div><div style=width:32%><img src=/images/HA-climate-modbus/HA1.png>
<img src=/images/HA-climate-modbus/HA2.png></div></div><p>玩Home Assistant有一段日子了。一直想把家里的中央空调接入进去。无意间Google到<code>Yonsm</code>老师的blog好像看到了一线希望：<a href=https://yonsm.github.io/modbus/>《ModBus 空调组件及中央空调接入 Home Assistant 简述》</a>。</p><p>于是按照文章和论坛中讨论的指引购入了相关的模块。由于第一次玩modbus这个工业互联协议，中间也走了不少弯路。这里对<a href=https://yonsm.github.io/modbus/>《ModBus 空调组件及中央空调接入 Home Assistant 简述》</a>没有提及的细节做一个补充.</p><p>开始之前首先要在心理上做好打持久战的准备😱️</p><h2 id=需要材料>需要材料</h2><ol><li>modbus空调网关</li><li>网关电源</li><li>万用表（测电源极性）</li><li>modbus 转TCP串口服务器</li></ol><p><img src=/images/HA-climate-modbus/tools.jpeg alt=tools></p><h2 id=12v变压器正负极>12V变压器正负极</h2><figure class=floatright><img src=/images/HA-climate-modbus/wechat1.png width=100px></figure><p>空调智能网关的电源接口是一对正负极的接线端子，电压12V-24V。发货过来没有配电源。我把家里闲置的交换机电源剪掉DC接头，剥出两根正负极电源线插进去。问题是直流电源，我并不知道哪一根是正极哪一根是负极。线的胶皮上有一根是黑白相间的，有一根是全黑的。我想应该有一个工业标准来规定线的正负极线的颜色。Google之后众说纷纭。问了卖家技术指导（见图）：</p><p>保险起见还是在马云家买了个万用表测了电源正负极，接通连上。</p><h2 id=如何获取modbus协议地址>如何获取modbus协议地址</h2><p>按照<code>简介</code>中提供的配置方案，控制空调的各个操作都是通过对modbus不同的协议地址的读写访问进行的。所以获取modbus的协议地址是成功的关键。</p><p>卖家告诉我需要用到<a href=https://www.modbustools.com/modbus_poll.html>modbuspoll</a>。</p><h2 id=空调网关指示灯>空调网关指示灯</h2><p>商品页面上介绍，空调网关正常状态应该是<code>绿灯闪烁</code>。而我拿到的机器一直是<code>红灯闪烁</code>。</p><p><img src=/images/HA-climate-modbus/modbus_light.png alt="modbus light"></p><p><img src=/images/HA-climate-modbus/wechat2.png alt>{:style="width:80px;float: right;margin-right: 7px;margin-top: 7px; margin-left: 15px;"}</p><p>问了店家后确认是批次问题，有些批次是红灯正常的。。。emmmm只能抱着将信将疑的态度继续调试了。</p><h2 id=空调智能网关调试>空调智能网关调试</h2><p>为了确定我收到的网关是否有故障，按照技术指导的提醒可以直接把网关连到电脑的串口。由于我身边的电脑都是Mac，只能又在马老板家买了USB转RS 232 模块，特地选了带串口RS 232转485的。</p><p><img src=/images/HA-climate-modbus/adapter_tb.png alt>{:style="width:60px;float: left;margin-right: 7px;margin-top: 7px; margin-left: 15px;"}</p><p>按照说明连好线路，设置好串口和modbuspoll，在可以在5xxx的地址段看到数据表示空调网关可以正常工作。</p><h2 id=串口服务器配置>串口服务器配置</h2><p>有人w610支持内部modbus RTU转modbus IP。我一开始理所当然的认为应该选择<code>modebus TCP &lt;=> modbus RTU</code>模式，然后在modbuspoll中也设置成了这个模式。几经波折后才想明白：在串口服务器上选择这个模式后就已经做了一次转换，在modbuspoll中收到的数据格式应该是<code>modbus TCP</code>。</p><p>我最后的解决方案是在串口服务器上数据传输模式设置成<code>透明传输模式</code>，在调试时modbuspoll中设置成<code>modbus TCP &lt;=> modbus RTU</code>。</p><p>其他的设置相对简单，我空调机位边没有网线。所以串口服务器配置成连接家里的无线网络（STA模式）。</p><p>串口相关设置可以参考截图。</p><div style=width:100%;display:flex;display:-webkit-flex><div style=width:40%><img src=/images/HA-climate-modbus/modbus_server_config_1.png></div><div style=width:48%><img src=/images/HA-climate-modbus/modbus_server_config_2.png></div></div><h2 id=modbuspoll配置>modbuspoll配置</h2><p>前面有提到modbuspoll 连接设置里面模式选择<code>modbus TCP &lt;=> modbus RTU</code>，填写好串口服务器IP和端口地址就可以了。</p><p>modbus协议地址可以通过在modbuspoll中设置<code>Read/Write Definition</code>来获取。</p><p>具体做法：新建窗口 ➡️️ 右键菜单<code>Read/Write Definition</code> ➡️️ <code>Function</code>选不同的地址段位，<code>Quantity</code>可以输入最大值 125。</p><div style=width:100%;display:flex;display:-webkit-flex;flex-wrap:wrap><div style=width:100%><img src=/images/HA-climate-modbus/modbuspoll1.jpeg></div><div style=width:50%><img src=/images/HA-climate-modbus/modbuspoll2.jpeg></div><div style=width:50%><img src=/images/HA-climate-modbus/modbuspoll3.jpeg></div></div><p>我这里有一个快捷方式，修改地址就能用。</p><p><a href=/files/Modbus-Poll%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE.rar>modbuspoll 快捷方式</a></p><h2 id=信号线>信号线</h2><p><img src=/images/HA-climate-modbus/line_tb.png alt>{:style="width:100px;float: right;margin-right: 7px;margin-top: 7px; margin-left: 15px;"}</p><p>一开始用DC电源上剪下来的线作为信号线，但是屡次失败后怀疑是线材的问题。问了店家技术指导说短距离应该没问题。保险起见还是在马云家买了标准的信号线材，跟空调公司安装的一样。分别买了0.5平和1平的，实际使用发现0.5平正好。</p><h2 id=空调线路>空调线路</h2><div style=width:100%;display:flex;display:-webkit-flex;flex-wrap:wrap><div style=width:50%><img src=/images/HA-climate-modbus/circuit_diagram.jpeg></div><div style=width:50%><img src=/images/HA-climate-modbus/interface.jpeg></div></div><p>Yonsm老师说接空调线路是最麻烦的。不过他也在文中提到了只要<code>接空调的F1、F2（空调的第三、第四接口）端子到空调网关U3的A、B接口就可以了</code>。</p><p>我的海信荣耀系列跟大金不太一样。拆下检修口保护罩，背后有一副电路图。看到<code>A、B</code>接口后我兴奋地认为这就是我要找的接口。调试无果后，第二次拆下保护罩发现旁边有<code>switch</code>的字样。原来这是这台内机的控制面板端口。按照modbus的原理，我大概猜测，这个端口因该只会有这台内机的数据信号。正确的端口因该是旁边的两个<code>通讯/Transmission</code>端子。</p><blockquote class=blockquote-center cite="https://bbs.hassbian.com/forum.php?mod=redirect&goto=findpost&ptid=3581&pid=89367">一般的情况（1外机+多内机）是内外机都可以。如果是那种多外机的情况，要接在外面，但这个一般家庭没有多外机的重要空调吧。<br><br><strong>Yonsm</strong></blockquote><h2 id=slave-地址>slave 地址</h2><p>modbus默认slave地址是1，我家海信的地址是1不需要修改（据说大金不是1）。<code>HomeAssistant</code>需要改地址可以添加参数<code>slave: x</code></p><p>例如：</p><div class=highlight><pre class=chroma><code class=language-json data-lang=json><span class=err>temperature:</span> <span class=p>{</span><span class=err>registers:</span> <span class=err>[3,7,11],</span> <span class=err>register_type:</span> <span class=err>input,</span> <span class=err>scale:</span> <span class=err>0.1,</span> <span class=err>slave:</span> <span class=err>3</span><span class=p>}</span>
</code></pre></div><p>没有验证，来源：<a href="https://bbs.hassbian.com/forum.php?mod=redirect&goto=findpost&ptid=3581&pid=125911">帖子80楼</a></p><h2 id=调试顺序>调试顺序</h2><p>如果你手上正好有串口转modbus 485的模块，可以先连上调试一下。看一下modbuspoll 中5xxx段有没有数据。</p><p>否则可以先连接好串口服务器和空调智能网关，配置好串口服务器后。通过wifi在modbus中取到5xxx段的数据（一般来说两个硬件不会有问题）。然后把空调连上空调网关U3端口，通过wifi取到对应的协议地址。</p></div><div class=post_footer></div></div><div class=doc_comments></div></div></div></div><a id=back_to_top href=# class=back_to_top><i class=ri-arrow-up-s-line></i></a><footer class=footer><div class=powered_by><a href=https://varkai.com>Designed by VarKai,</a>
<a href=http://www.gohugo.io/>Proudly published with Hugo</a></div><div class=footer_slogan><span>人生没有白走的路，每一步都算数</span></div></footer><script src=http://localhost:1313/js/jquery-3.5.1.min.js></script><link href=http://localhost:1313/css/fancybox.min.css rel=stylesheet><script src=http://localhost:1313/js/fancybox.min.js></script><script src=http://localhost:1313/js/zozo.js></script><script type=text/javascript async src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML">MathJax.Hub.Config({tex2jax:{inlineMath:[['$','$'],['\\(','\\)']],displayMath:[['$$','$$'],['\[\[','\]\]']],processEscapes:true,processEnvironments:true,skipTags:['script','noscript','style','textarea','pre'],TeX:{equationNumbers:{autoNumber:"AMS"},extensions:["AMSmath.js","AMSsymbols.js"]}}});MathJax.Hub.Queue(function(){var all=MathJax.Hub.getAllJax(),i;for(i=0;i<all.length;i+=1){all[i].SourceElement().parentNode.className+=' has-jax';}});</script><style>code.has-jax{font:inherit;font-size:100%;background:inherit;border:inherit;color:#515151}</style></body></html>